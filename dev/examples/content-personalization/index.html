
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Online machine learning in Python">
      
      
        <meta name="author" content="The Fellowship of Online Machine Learning">
      
      
        <link rel="canonical" href="https://riverml.xyz/dev/examples/content-personalization/">
      
      
        <link rel="prev" href="../building-a-simple-nowcasting-model/">
      
      
        <link rel="next" href="../debugging-a-pipeline/">
      
      
      <link rel="icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.23">
    
    
      
        <title>Content personalization - River</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Sans:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Fira Sans";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      <script
  defer
  src="https://eu.umami.is/script.js"
  data-website-id="b9f84709-bbc5-48b5-b43b-ef0bcc45a1f8"
></script>
    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#content-personalization" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="River" class="md-header__button md-logo" aria-label="River" data-md-component="logo">
      
  <img src="../../img/icon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            River
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Content personalization
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/online-ml/river" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    online-ml/river
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../introduction/installation/" class="md-tabs__link">
          
  
    
  
  Introduction üçº

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../recipes/reading-data/" class="md-tabs__link">
          
  
    
  
  Recipes üåÆ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api/overview/" class="md-tabs__link">
          
  
    
  
  API reference üç±

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../batch-to-online/" class="md-tabs__link">
          
  
    
  
  Examples üå∂Ô∏è

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../faq/" class="md-tabs__link">
          
  
    
  
  FAQ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../releases/unreleased/" class="md-tabs__link">
          
  
    
  
  Releases

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../benchmarks/Binary%20classification/" class="md-tabs__link">
          
  
    
  
  Benchmarks

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../license/license/" class="md-tabs__link">
          
  
    
  
  License üìù

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="River" class="md-nav__button md-logo" aria-label="River" data-md-component="logo">
      
  <img src="../../img/icon.png" alt="logo">

    </a>
    River
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/online-ml/river" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    online-ml/river
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../introduction/installation/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Introduction üçº
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../recipes/reading-data/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Recipes üåÆ
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../api/overview/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    API reference üç±
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Examples üå∂Ô∏è
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Examples üå∂Ô∏è
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../batch-to-online/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    From batch to online/stream
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../bike-sharing-forecasting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bike-sharing forecasting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../building-a-simple-nowcasting-model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building a simple nowcasting model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Content personalization
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Content personalization
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#without-context" class="md-nav__link">
    <span class="md-ellipsis">
      Without context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#with-context" class="md-nav__link">
    <span class="md-ellipsis">
      With context
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging-a-pipeline/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Debugging a pipeline
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../imbalanced-learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Working with imbalanced data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quantile-regression-uncertainty/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Handling uncertainty with quantile regression
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sentence-classification/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sentence classification
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../the-art-of-using-pipelines/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The art of using pipelines
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../matrix-factorization-for-recommender-systems/part-1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Matrix factorization for recommender systems
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../faq/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    FAQ
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../releases/unreleased/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Releases
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../benchmarks/Binary%20classification/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Benchmarks
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../license/license/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    License üìù
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#without-context" class="md-nav__link">
    <span class="md-ellipsis">
      Without context
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#with-context" class="md-nav__link">
    <span class="md-ellipsis">
      With context
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="content-personalization">Content personalization<a class="headerlink" href="#content-personalization" title="Permanent link">&para;</a></h1>
<h2 id="without-context">Without context<a class="headerlink" href="#without-context" title="Permanent link">&para;</a></h2>
<p>This example takes inspiration from Vowpal Wabbit's <a href="https://vowpalwabbit.org/tutorials/cb_simulation.html">excellent tutorial</a>.</p>
<p>Content personalization is about taking into account user preferences. It's a special case of recommender systems. Ideally, side-information should be taken into account in addition to the user. But we'll start with something simpler. We'll assume that each user has stable preferences that are independent of the context. We capture this by implementing a "reward" function.</p>
<div class="language-python highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="n">time_of_day</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span>

    <span class="n">USER_LIKED_ARTICLE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">USER_DISLIKED_ARTICLE</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="s1">&#39;Tom&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_of_day</span> <span class="o">==</span> <span class="s1">&#39;morning&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">time_of_day</span> <span class="o">==</span> <span class="s1">&#39;afternoon&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;music&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>
    <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="s1">&#39;Anna&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">time_of_day</span> <span class="o">==</span> <span class="s1">&#39;morning&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">elif</span> <span class="n">time_of_day</span> <span class="o">==</span> <span class="s1">&#39;afternoon&#39;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_LIKED_ARTICLE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">USER_DISLIKED_ARTICLE</span>

<span class="n">get_reward</span><span class="p">(</span><span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;politics&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="s1">&#39;morning&#39;</span><span class="p">})</span>
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>1
</code></pre></div>
<p>Measuring the performance of a recommendation is not straightforward, mostly because of the interactive aspect of recommender systems. In a real situation, recommendations are presented to a user, and the user gives feedback indicating whether they like what they have been recommended or not. This feedback loop can't be captured entirely by a historical dataset. Some kind of simulator is required to generate recommendations and capture feedback. We already have a reward function. Now let's implement a simulation function.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="k">def</span> <span class="nf">plot_ctr</span><span class="p">(</span><span class="n">ctr</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">ctr</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;n_iterations&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;CTR&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;final CTR: </span><span class="si">{</span><span class="n">ctr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2%</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">users</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Tom&#39;</span><span class="p">,</span> <span class="s1">&#39;Anna&#39;</span><span class="p">]</span>
<span class="n">times_of_day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">]</span>
<span class="n">items</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;politics&#39;</span><span class="p">,</span> <span class="s1">&#39;sports&#39;</span><span class="p">,</span> <span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;finance&#39;</span><span class="p">,</span> <span class="s1">&#39;health&#39;</span><span class="p">,</span> <span class="s1">&#39;camping&#39;</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">reward_func</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>

    <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n_clicks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># click-through rate along time</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="c1"># Generate a context at random</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="c1"># Make a single recommendation</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Measure the reward</span>
        <span class="n">clicked</span> <span class="o">=</span> <span class="n">reward_func</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">n_clicks</span> <span class="o">+=</span> <span class="n">clicked</span>
        <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_clicks</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Update the model</span>
        <span class="n">model</span><span class="o">.</span><span class="n">learn_one</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">clicked</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

    <span class="n">plot_ctr</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
</code></pre></div>
<p>This simulation function does quite a few things. It can be seen as a simple reinforcement learning simulation. It samples a user, and then ask the model to provide a single recommendation. The user then gives as to whether they liked the recommendation or not. Crucially, the user doesn't tell us what item they would have liked. We could model this as a multi-class classification problem if that were the case.</p>
<p>The strategy parameter determines the mechanism used to generate the recommendations. The <code>'best'</code> strategy means that the items are each scored by the model, and are then ranked from the most preferred to the least preferred. Here the most preferred item is the one which gets recommended. But you could imagine all sorts of alternative ways to proceed.</p>
<p>We can first evaluate a recommended which acts completely at random. It assigns a random preference to each item, regardless of the user.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">river</span> <span class="kn">import</span> <span class="n">reco</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">reco</span><span class="o">.</span><span class="n">RandomNormal</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">simulate</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">get_reward</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_7_0.png" /></p>
<p>We can see that the click-through rate (CTR) oscillates around 28.74%. In fact, this model is expected to be correct <code>100 * (2 / 7)% = 28.57%</code> of the time. Indeed, each user likes two items, and there are seven items in total.</p>
<p>Let's now use the <code>Baseline</code> recommended. This one models each preference as the following sum:</p>
<div class="arithmatex">\[preference = \bar{y} + b_{u} + b_{i}\]</div>
<p>where</p>
<ul>
<li><span class="arithmatex">\(\bar{y}\)</span> is the average CTR overall</li>
<li><span class="arithmatex">\(b_{u}\)</span> is the average CTR per user minus <span class="arithmatex">\(\bar{y}\)</span> -- it's therefore called a <em>bias</em></li>
<li><span class="arithmatex">\(b_{i}\)</span> is the average CTR per item minus <span class="arithmatex">\(\bar{y}\)</span></li>
</ul>
<p>This model is considered to be a baseline because it doesn't actually learn what items are preferred by each user. Instead it models each user and item separately. We shouldn't expect it to be a strong model. It should however do better than the random model used above.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">reco</span><span class="o">.</span><span class="n">Baseline</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">simulate</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">get_reward</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_9_0.png" /></p>
<p>This baseline model seems perfect, which is surprising. The reason why it works so well is because both users have in common that they both like politics. The model therefore learns that the <code>'politics'</code> is a good item to recommend.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">model</span><span class="o">.</span><span class="n">i_biases</span>
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>defaultdict(Zeros (),
            {&#39;politics&#39;: 0.06389451550325113,
             &#39;music&#39;: -0.04041254194187752,
             &#39;camping&#39;: -0.040319730234734,
             &#39;health&#39;: -0.03581829597317823,
             &#39;food&#39;: -0.037778771188204816,
             &#39;finance&#39;: -0.04029646665611086,
             &#39;sports&#39;: -0.03661678982763635})
</code></pre></div>
<p>The model is not as performant if we use a reward function where both users have different preferences.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">simulate</span><span class="p">(</span>
    <span class="mi">5_000</span><span class="p">,</span>
    <span class="n">reward_func</span><span class="o">=</span><span class="k">lambda</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="p">(</span>
        <span class="n">item</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;music&#39;</span><span class="p">,</span> <span class="s1">&#39;politics&#39;</span><span class="p">}</span> <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="s2">&quot;Tom&quot;</span> <span class="k">else</span>
        <span class="n">item</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;food&#39;</span><span class="p">,</span> <span class="s1">&#39;sports&#39;</span><span class="p">}</span>
    <span class="p">),</span>
    <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
    <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_13_0.png" /></p>
<p>A good recommender model should at the very least understand what kind of items each user prefers. One of the simplest and yet performant way to do this is Simon Funk's SGD method he developped for the Netflix challenge and wrote about <a href="https://sifter.org/simon/journal/20061211.html">here</a>. It models each user and each item as latent vectors. The dot product of these two vectors is the expected preference of the user for the item.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">reco</span><span class="o">.</span><span class="n">FunkMF</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">simulate</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">get_reward</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_15_0.png" /></p>
<p>We can see that this model learns what items each user enjoys very well. Of course, there are some caveats. In our simulation, we ask the model to recommend the item most likely to be preferred for each user. Indeed, we rank all the items and pick the item at the top of the list. We do this many times for only two users.</p>
<p>This is of course not realistic. Users will get fed up with recommendations if they're always shown the same item. It's important to include diversity into recommendations, and to let the model explore other options instead of always focusing on the item with the highest score. This is where evaluating recommender systems gets tricky: the reward function itself is difficult to model.</p>
<p>We will keep ignoring these caveats in this notebook. Instead we will focus on a different concern: making recommendations when context is involved.</p>
<h2 id="with-context">With context<a class="headerlink" href="#with-context" title="Permanent link">&para;</a></h2>
<p>We'll add some context by making it so that user preferences change depending on the time the day. Very simply, preferences might change from morning to afternoon. This is captured by the following reward function.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">times_of_day</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;morning&#39;</span><span class="p">,</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_reward</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="s1">&#39;Tom&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;morning&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;music&#39;</span>
    <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="s1">&#39;Anna&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;morning&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;sports&#39;</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;afternoon&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">item</span> <span class="o">==</span> <span class="s1">&#39;politics&#39;</span>
</code></pre></div>
<p>We have to update our simulation function to generate a random context at each step. We also want our model to use it for recommending items as well as learning.</p>
<div class="language-python highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">reward_func</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>

    <span class="n">rng</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">n_clicks</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ctr</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>

        <span class="n">user</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">users</span><span class="p">)</span>

        <span class="c1"># New: pass a context</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">:</span> <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">times_of_day</span><span class="p">)}</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">context</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">clicked</span> <span class="o">=</span> <span class="n">reward_func</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">n_clicks</span> <span class="o">+=</span> <span class="n">clicked</span>
        <span class="n">ctr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n_clicks</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># New: pass a context</span>
        <span class="n">model</span><span class="o">.</span><span class="n">learn_one</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">clicked</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="n">plot_ctr</span><span class="p">(</span><span class="n">ctr</span><span class="p">)</span>
</code></pre></div>
<p>Not all models are capable of taking into account context. For instance, the <code>FunkMF</code> model only models users and items. It completely ignores the context, even when we provide one. All recommender models inherit from the base <code>Recommender</code> class. They also have a property which indicates whether or not they are able to handle context:</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">reco</span><span class="o">.</span><span class="n">FunkMF</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">is_contextual</span>
</code></pre></div>
<div class="language-text highlight"><pre><span></span><code>False
</code></pre></div>
<p>Let's see well it performs.</p>
<div class="language-python highlight"><pre><span></span><code><span class="n">simulate</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">get_reward</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_25_0.png" /></p>
<p>The performance has roughly been divided by half. This is most likely because there are now two times of day, and if the model has learnt preferences for one time of the day, then it's expected to be wrong half of the time.</p>
<p>Before delving into recsys models that can handle context, a simple hack is to notice that we can append the time of day to the user. This effectively results in new users which our model can distinguish between. We could apply this trick during the simulation, but we can also override the behavior of the <code>learn_one</code> and <code>rank</code> methods of our model.</p>
<div class="language-python highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FunkMFWithHack</span><span class="p">(</span><span class="n">reco</span><span class="o">.</span><span class="n">FunkMF</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">learn_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">learn_one</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;time_of_day&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">FunkMFWithHack</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="mi">29</span><span class="p">)</span>
<span class="n">simulate</span><span class="p">(</span><span class="mi">5_000</span><span class="p">,</span> <span class="n">get_reward</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</code></pre></div>
<p><img alt="png" src="../content-personalization_files/content-personalization_27_0.png" /></p>
<p>We can verify that the model has learnt the correct preferences by looking at the expected preference for each <code>(user, item)</code> pair.</p>
<div class="language-python highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;item&#39;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
            <span class="s1">&#39;preference&#39;</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_one</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">u_latents</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">i_latents</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;item&#39;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">highlight_max</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>
<style type="text/css">
#T_efa54_row0_col5, #T_efa54_row1_col6, #T_efa54_row2_col4, #T_efa54_row3_col5 {
  background-color: lightgreen;
}
</style>
<table id="T_efa54">
  <thead>
    <tr>
      <th class="blank level0" >&nbsp;</th>
      <th id="T_efa54_level0_col0" class="col_heading level0 col0" colspan="7">preference</th>
    </tr>
    <tr>
      <th class="index_name level1" >item</th>
      <th id="T_efa54_level1_col0" class="col_heading level1 col0" >camping</th>
      <th id="T_efa54_level1_col1" class="col_heading level1 col1" >finance</th>
      <th id="T_efa54_level1_col2" class="col_heading level1 col2" >food</th>
      <th id="T_efa54_level1_col3" class="col_heading level1 col3" >health</th>
      <th id="T_efa54_level1_col4" class="col_heading level1 col4" >music</th>
      <th id="T_efa54_level1_col5" class="col_heading level1 col5" >politics</th>
      <th id="T_efa54_level1_col6" class="col_heading level1 col6" >sports</th>
    </tr>
    <tr>
      <th class="index_name level0" >user</th>
      <th class="blank col0" >&nbsp;</th>
      <th class="blank col1" >&nbsp;</th>
      <th class="blank col2" >&nbsp;</th>
      <th class="blank col3" >&nbsp;</th>
      <th class="blank col4" >&nbsp;</th>
      <th class="blank col5" >&nbsp;</th>
      <th class="blank col6" >&nbsp;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th id="T_efa54_level0_row0" class="row_heading level0 row0" >Anna@afternoon</th>
      <td id="T_efa54_row0_col0" class="data row0 col0" >-0.018105</td>
      <td id="T_efa54_row0_col1" class="data row0 col1" >0.032865</td>
      <td id="T_efa54_row0_col2" class="data row0 col2" >0.069222</td>
      <td id="T_efa54_row0_col3" class="data row0 col3" >-0.059041</td>
      <td id="T_efa54_row0_col4" class="data row0 col4" >0.168353</td>
      <td id="T_efa54_row0_col5" class="data row0 col5" >1.000000</td>
      <td id="T_efa54_row0_col6" class="data row0 col6" >0.195960</td>
    </tr>
    <tr>
      <th id="T_efa54_level0_row1" class="row_heading level0 row1" >Anna@morning</th>
      <td id="T_efa54_row1_col0" class="data row1 col0" >-0.117577</td>
      <td id="T_efa54_row1_col1" class="data row1 col1" >0.081131</td>
      <td id="T_efa54_row1_col2" class="data row1 col2" >0.076300</td>
      <td id="T_efa54_row1_col3" class="data row1 col3" >-0.136399</td>
      <td id="T_efa54_row1_col4" class="data row1 col4" >0.154483</td>
      <td id="T_efa54_row1_col5" class="data row1 col5" >0.221890</td>
      <td id="T_efa54_row1_col6" class="data row1 col6" >1.000000</td>
    </tr>
    <tr>
      <th id="T_efa54_level0_row2" class="row_heading level0 row2" >Tom@afternoon</th>
      <td id="T_efa54_row2_col0" class="data row2 col0" >0.057220</td>
      <td id="T_efa54_row2_col1" class="data row2 col1" >-0.027115</td>
      <td id="T_efa54_row2_col2" class="data row2 col2" >-0.074671</td>
      <td id="T_efa54_row2_col3" class="data row2 col3" >-0.233071</td>
      <td id="T_efa54_row2_col4" class="data row2 col4" >1.000000</td>
      <td id="T_efa54_row2_col5" class="data row2 col5" >0.163607</td>
      <td id="T_efa54_row2_col6" class="data row2 col6" >0.141781</td>
    </tr>
    <tr>
      <th id="T_efa54_level0_row3" class="row_heading level0 row3" >Tom@morning</th>
      <td id="T_efa54_row3_col0" class="data row3 col0" >-0.028562</td>
      <td id="T_efa54_row3_col1" class="data row3 col1" >-0.005428</td>
      <td id="T_efa54_row3_col2" class="data row3 col2" >0.061163</td>
      <td id="T_efa54_row3_col3" class="data row3 col3" >-0.050107</td>
      <td id="T_efa54_row3_col4" class="data row3 col4" >0.063483</td>
      <td id="T_efa54_row3_col5" class="data row3 col5" >1.000000</td>
      <td id="T_efa54_row3_col6" class="data row3 col6" >0.125515</td>
    </tr>
  </tbody>
</table>









  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        

<!-- Application footer -->
<footer class="md-footer">

  <!-- Further information -->
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">

      <!-- Copyright and theme information -->
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 - 2023
          </div>
        
        Made with
        <a
          href="https://squidfunk.github.io/mkdocs-material/"
          target="_blank" rel="noopener"
        >
          Material for MkDocs
        </a>
      </div>

      <!-- Social links -->
      <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/online-ml/river" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
</div>
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.tabs", "navigation.instant", "navigation.indexes", "navigation.prune"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ebd0bdb7.min.js"></script>
      
        <script src="../../js/mkdocs-charts-plugin.js"></script>
      
        <script src="../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3.2/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../../javascripts/tablesort.js"></script>
      
    
  </body>
</html>